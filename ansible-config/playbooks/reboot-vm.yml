- name: Restart Virtual Machine
  hosts: localhost
  gather_facts: false
  become: true
  tasks:
    - name: Shutting Down VM
      shell: virsh destroy {{ GUEST_NAME }}

    - name: Ensure VM Shut Down
      shell:
        cmd: virsh list --all | grep master1 | grep 'shut off'
      register: vm_up_list
      until: vm_up_list.stdout | length > 0
      retries: 30
      delay: 10

    - name: Ensure VM is started
      virt:
        name: "{{ GUEST_NAME }}"
        state: running
      register: vm_start_results
      until: "vm_start_results is success"
      retries: 15
      delay: 2

    - name: Get IP Address
      shell: virsh domifaddr {{ GUEST_NAME }} | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b'
      register: defined_vm_ip_result
      until: "defined_vm_ip_result is success"
      retries: 30
      delay: 5

    - name: Set IP Address
      set_fact:
        vm_ip: "{{ item }}"
      with_items: "{{ defined_vm_ip_result.stdout }}"

    - name: Wait for ssh to come up
      wait_for: host="{{ vm_ip }}" port=22 delay=10 timeout=300
